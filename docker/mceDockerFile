

# Use the official Microsoft Windows Server image
#FROM mcr.microsoft.com/windows/servercore:ltsc2019
FROM mcr.microsoft.com/windows/server:ltsc2022
RUN echo
ARG MSYS2_INSTALLER_URL=https://github.com/msys2/msys2-installer/releases/download/2020-06-29/msys2-base-x86_64-20200629.sfx.exe

RUN curl -L -o C:\msys2.exe %MSYS2_INSTALLER_URL%
RUN C:\msys2.exe -y -o"C:\"

RUN C:\msys64\usr\bin\bash.exe -lc " "
RUN C:\msys64\usr\bin\bash.exe -lc "pacman --noconfirm -Syuu"
RUN C:\msys64\usr\bin\bash.exe -lc "pacman --noconfirm -Scc"
RUN C:\msys64\usr\bin\bash.exe -lc "pacman -Syu --noconfirm"
RUN C:\msys64\usr\bin\bash.exe -lc "pacman -S --noconfirm git"
RUN C:\msys64\usr\bin\bash.exe -lc "pacman -S --noconfirm make automake autoconf libtool pkg-config gcc curl python3"
RUN C:\msys64\usr\bin\bash.exe -lc "pacman -S --noconfirm mingw-w64-x86_64-gcc mingw-w64-x86_64-pkg-config mingw-w64-x86_64-libzip mingw-w64-x86_64-openssl mingw-w64-x86_64-curl"
RUN setx MSYSTEM "MINGW64"
RUN setx MSYS2_PATH_TYPE "inherit"

RUN mkdir C:\libimobiledevice
WORKDIR C:\\libimobiledevice

RUN C:\msys64\usr\bin\bash.exe -lc "gcc --version"

RUN C:\msys64\usr\bin\bash.exe -lc " \
    cd /c/libimobiledevice && \
    git clone https://github.com/libimobiledevice/libplist.git && \
    git clone https://github.com/libimobiledevice/libtatsu.git && \
    git clone https://github.com/libimobiledevice/libimobiledevice-glue.git && \
    git clone https://github.com/libimobiledevice/libusbmuxd.git && \
    git clone https://github.com/libimobiledevice/libimobiledevice.git && \
    git clone https://github.com/libimobiledevice/idevicerestore.git"

WORKDIR C:\\libimobiledevice\\libplist
RUN C:\msys64\usr\bin\bash.exe -lc "cd /c/libimobiledevice/libplist && ./autogen.sh --enable-static --disable-shared && make && make install"

RUN C:\msys64\usr\bin\bash.exe -lc "pacman -S --noconfirm mingw-w64-x86_64-libusb"
RUN C:\msys64\usr\bin\bash.exe -lc "cd /c/libimobiledevice && git clone https://github.com/libimobiledevice/libirecovery.git"

WORKDIR C:\\libimobiledevice\\libimobiledevice-glue
RUN C:\msys64\usr\bin\bash.exe -lc "cd /c/libimobiledevice/libimobiledevice-glue && ./autogen.sh --enable-static --disable-shared CFLAGS='-DLIBPLIST_STATIC' && make && make install"

WORKDIR C:\\libimobiledevice\\libtatsu
RUN C:\msys64\usr\bin\bash.exe -lc "cd /c/libimobiledevice/libtatsu && ./autogen.sh --enable-static --disable-shared CFLAGS='-DLIBPLIST_STATIC -DCURL_STATICLIB' && make && make install"

WORKDIR C:\\libimobiledevice\\libusbmuxd
RUN C:\msys64\usr\bin\bash.exe -lc "cd /c/libimobiledevice/libusbmuxd && ./autogen.sh --enable-static --disable-shared CFLAGS='-DLIMD_GLUE_STATIC -DLIBPLIST_STATIC' && make -C src && make -C include && make -C src install && make -C include install"

WORKDIR C:\\libimobiledevice\\libimobiledevice
RUN C:\msys64\usr\bin\bash.exe -lc "cd /c/libimobiledevice/libimobiledevice && ./autogen.sh --enable-static --disable-shared CFLAGS='-DLIMD_GLUE_STATIC -DLIBUSBMUXD_STATIC -DLIBPLIST_STATIC' && make -C 3rd_party && make -C common && make -C src && make -C include && make -C src install && make -C include install"

WORKDIR C:\\libimobiledevice
COPY docker/libirecovery-1.0.dll C:\\msys64\\mingw64\\bin\\libirecovery-1.0.dll
COPY docker/libirecovery-1.0.dll.a C:\\msys64\\mingw64\\lib\\libirecovery-1.0.dll.a
COPY docker/libirecovery.h C:\\msys64\\mingw64\\include\\libirecovery.h
COPY docker/libirecovery-1.0.pc C:\\msys64\\mingw64\\lib\\pkgconfig\\libirecovery-1.0.pc

RUN C:\msys64\usr\bin\bash.exe -lc "cd /c/libimobiledevice && git clone -b activation-error-build https://github.com/mceSystems/idevicerestore.git mceIdevicerestore"

WORKDIR C:\\libimobiledevice\\mceIdevicerestore
RUN C:\msys64\usr\bin\bash.exe -lc "cd /c/libimobiledevice/mceIdevicerestore && export PKG_CONFIG_PATH=/mingw64/lib/pkgconfig:/usr/local/lib/pkgconfig && ./autogen.sh --enable-static --disable-shared CFLAGS='-DLIMD_GLUE_STATIC -DLIBUSBMUXD_STATIC -DLIBIMOBILEDEVICE_STATIC -DLIBPLIST_STATIC -DLIBTATSU_STATIC -DCURL_STATICLIB' LDFLAGS='-static-libgcc' && make && make install"

RUN C:\msys64\usr\bin\bash.exe -lc "cp /c/libimobiledevice/mceIdevicerestore/src/idevicerestore.exe /c/idevicerestore.exe && ls -lh /c/idevicerestore.exe"

